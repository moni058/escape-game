<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚¿ã‚¤ãƒˆãƒ«</title>
  <link rel ="stylesheet" href ="/game.css">
</head>
<body>
	<!-- ã‚²ãƒ¼ãƒ ç”»é¢è¡¨ç¤ºéƒ¨åˆ† -->
	<p id = "floor">floor</p>
	<p id = "timer"></p>
	<p id = "message"></p>
	<p id ="center"></p>
	<p id ="sub"></p></p>
	<!-- ãƒªã‚¶ãƒ«ãƒˆç”»é¢è¡¨ç¤ºéƒ¨åˆ† -->
	<p id = "ranking"></p>
	<p id = "total"></p></p>
	<p id = "resultFloor"></p></p>
	<p id = "tryCount"></p></p>
	<!-- ç”»åƒãƒ»å‹•ç”»è¦ç´ -->
	<video id="ruleVideo" class = "fullscreen" src="second_examination_first.mp4"></video>
	<video id="trainCount" class = "main" src="é›»è»Šã‚«ã‚¦ãƒ³ãƒˆ.mp4"></video>
	<video id="daruma" class = "main" src="ã ã‚‹ã¾ã•ã‚“.mp4"></video>
	<video id="clear" class = fullscreen src="ã‚¯ãƒªã‚¢å‹•ç”».mp4"></video>
	<img id = "startGamen" class = "fulldisp" src ="startGamen.png">
	<img id = "playerRankC" class = "fullscreen" src ="playerRankC.jpg">
	<img id = "playerRankB" class = "fullscreen" src ="playerRankB.jpg">
	<img id = "playerRankA" class = "fullscreen" src ="playerRankA.jpg">
	<img id = "playerRankA+" class = "fullscreen" src ="playerRankA+.jpg">
	<img id = "playerRankS" class = "fullscreen" src ="playerRankS.jpg">
	<img id ="transition" class ="fullscreen" src ="transition.png">
	<img id ="exit" class ="fullscreen" src ="é€€å‡ºãƒ–ãƒ¼ã‚¹1.png">
	<canvas id="board"></canvas>
	<img id ="main" class = "main">
	<script>
		/*
		* htmlè¦ç´ ã®å–å¾—
		*/
		const floor = document.getElementById('floor');
		const message = document.getElementById("message");
		const startGamen = document.getElementById("startGamen");
		const ruleVideo = document.getElementById("ruleVideo");
		const transition = document.getElementById("transition");
		const main = document.getElementById("main");
		const center = document.getElementById("center");
		const trainCount = document.getElementById("trainCount");
		const daruma = document.getElementById("daruma");
		const sub = document.getElementById("sub");
		const tryCount = document.getElementById("tryCount");
		const ranking = document.getElementById("ranking");
		const total = document.getElementById("total");
		const resultFloor = document.getElementById("resultFloor");
		const exit = document.getElementById("exit");
		const clear = document.getElementById("clear");
		
		/*
		* Audioã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å®£è¨€
		*/
		const correctMusic = new Audio("æ­£è§£7.mp3"); // æ­£è§£éŸ³
		const moveMusic = new Audio("ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—1.mp3"); // ç§»å‹•éŸ³
		const incorrectMusic = new Audio("ã‚¨ãƒ©ãƒ¼1.mp3"); // ä¸æ­£è§£éŸ³
		const chaka2 = new Audio("æ‹³éŠƒã®å¼¾åˆ‡ã‚Œ.mp3");
		const chaka1 = new Audio("æ‹³éŠƒã®å¼¾åˆ‡ã‚Œ_1.mp3");
		
		/*
		* ä¸€ç­†æ›¸ãã®ãƒãƒƒãƒ—å®£è¨€
		*/
		const level1Map = [
		[1,1,1,1,1,1,1,1,1,1],
		[1,0,0,1,0,1,0,0,1,1],
		[1,0,0,0,0,1,0,0,1,1],
		[1,0,0,0,0,0,0,0,1,1],
		[1,0,0,0,0,0,0,0,1,1],
		[1,0,0,0,0,0,0,0,1,1],
		[1,0,0,0,0,0,0,0,1,1],
		[1,1,1,1,1,1,1,1,1,1],
		];
		
		const level2Map = [
		[0,0,0,1,1,1,0,0,0,0],
		[0,0,0,0,0,1,0,1,0,0],
		[0,0,0,0,1,1,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0],
		[0,0,0,1,0,0,0,1,0,0],
		[0,0,0,1,0,0,0,1,0,0],
		[0,0,0,0,1,0,0,1,0,0],
		[0,0,1,0,0,0,0,0,0,0],
		];
		
		const specMap = [
		[0,0,0,1,0,0,0,0,0,1],
		[0,0,0,1,0,0,0,1,0,1],
		[0,0,1,1,0,0,0,1,0,1],
		[0,0,0,0,0,1,0,0,0,1],
		[0,0,0,1,1,0,0,0,0,1],
		[0,0,0,1,1,0,0,0,0,1],
		[0,0,0,0,0,0,0,0,0,1],
		[0,0,0,0,0,0,0,0,0,1],
		[0,0,0,0,0,0,0,0,0,1]
		];
		
		/*
		* æ±ç”¨å¤‰æ•°ã®å®£è¨€
		*/
		let blinkInterval;
		let pollingInterval = null; //ãƒãƒ¼ãƒªãƒ³ã‚°ç”¨ã®å¤‰æ•°
		let player; //ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å¤‰æ•°
		const pcNum = 1;
		let canOperate = true;; // æ“ä½œå¯èƒ½ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
		let startFlg = false; // æœ€åˆã®ãƒœã‚¿ãƒ³æŠ¼ä¸‹ã§ã‚²ãƒ¼ãƒ ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆã™ã‚‹ãŸã‚ã®ãƒ•ãƒ©ã‚°
		const answerListAll = [0,0,0,0,0,0,0,0,0]; // ã€Œallã€ã®è§£ç­”ã§ä½¿ã†
		const answerListSequence = []; // ã€Œsequenceã€ã®è§£ç­”ã§ä½¿ã†
		let answerSet = new Set(); // ã€Œsequenceã€ã§é‡è¤‡ã‚’ç¢ºèªã™ã‚‹éš›ã«ä½¿ã†
		let oneStrokeMap = Array.from({ length: 8 }, () => Array(10).fill(0)); // ä¸€ç­†æ›¸ãã®çŠ¶æ³ã‚’ä¿å­˜ã™ã‚‹ãƒãƒƒãƒ—
		let oneX = 0; // ä¸€ç­†æ›¸ãã®xåº§æ¨™
		let oneY = 0; // ä¸€ç­†æ›¸ãã®yåº§æ¨™
		let boardFlg = false; // è§£ç­”ãƒœã‚¿ãƒ³ã«æ–‡å­—ã‚’ç½®ãã‹ã©ã†ã‹
		let flash1Flg = false; // ç‚¹æ»…å•é¡Œ1ã®å°‚ç”¨ãƒ•ãƒ©ã‚°
		let flash2Flg = false; // ç‚¹æ»…å•é¡Œ1ã®å°‚ç”¨ãƒ•ãƒ©ã‚°
		let simulSequenceFlg = false // ç‚¹æ»…æš—è¨˜ãƒ¬ãƒ™ãƒ«2ã®ãƒ•ãƒ©ã‚°(é€£ç¶šåŒæ™‚æŠ¼ã—ãƒ•ãƒ©ã‚°)
		let fruitFlg = false // ãƒ•ãƒ«ãƒ¼ãƒ„å•é¡Œã®ãƒ•ãƒ©ã‚°
		let simulSequenceCount = 0; // é€£ç¶šåŒæ™‚æŠ¼ã—å•é¡Œã®æ­£è§£æ•°ã®ã‚«ã‚¦ãƒ³ãƒˆ
		let userSet = new Set(); // ç•°å¤‰æ¢ã—ã®è§£ç­”ãƒªã‚¹ãƒˆ
		let chakaFlg = false;
		let chakaFlg2 = false;
		const circlePositions = []; // ãƒ©ã‚¤ãƒˆå•é¡Œã®4ã¤ã®å††ã®åº§æ¨™
		const positions = [];
		let circleStates = [0, 0, 0, 0]; // 0ï½3ã®å††ã®å¡—ã‚Šã¤ã¶ã—çŠ¶æ…‹ã‚’ç®¡ç†
		let sumCount = 1; // æ•°å­—ã‚’åˆè¨ˆã—ã¦ã„ãå•é¡Œ
		let totalSeconds;
		let doubleFlg = false; // é€£ç¶šæŠ¼ã—å•é¡Œã®2å›æŠ¼ã—å•é¡Œ
		let pianoFlg = false; // éŸ³éšå•é¡Œã®ãƒ•ãƒ©ã‚°
		let flashIndex = 0; // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æš—ç®—ã§é›£æ˜“åº¦ãŒå¤‰ã‚ã‚‹ãŸã³ã«ç­”ãˆã¨ã‹ã‚’å¤‰ãˆã‚‹ãŸã‚ã®ã‚„ã¤
		let flashMemoFlg = false; // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æš—è¨˜å•é¡Œã®ãƒ•ãƒ©ã‚°
		const cross = ["x","15","é¬¼","x","4","x","o","x","y","x","å¤œ","x","19","æœ","x","â™¦ï¸4","x","o","x","y","x",""]; // 10å€‹
		const prime = ["5","15","8","57","29","103","23","51","49","10","91","63","19","7","2","â™£ï¸6","1","68","0","99","75","21",""]; // 7å€‹
		let flashCulcFlg = false; // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æš—ç®—å•é¡Œã®ãƒ•ãƒ©ã‚°
		let crossFlg = false; // xã‚’æ•°ãˆã‚‹å•é¡Œã®ãƒ•ãƒ©ã‚°
		let tempIndex = 0; // perfectå•é¡Œã§æ­£è§£æ•°ã‚’ç®¡ç†ã™ã‚‹ãƒ•ãƒ©ã‚°
		const rainbowImageList = ["","tower_6th_rainbow/6color.png","tower_6th_rainbow/4color.png","tower_6th_rainbow/fullcolor.png","tower_6th_rainbow/2color.png","tower_6th_rainbow/5color.png","tower_6th_rainbow/3color.png"] // 2æ™‚ç”»åƒã®ãƒªã‚¹ãƒˆ
		let specStrokeFlg = false; // ä¸€ç­†æ›¸ãå•é¡Œã®ç‰¹æ®Šãƒ•ãƒ©ã‚°
		let trainFlg = false; // ä¹—å®¢ã‚«ã‚¦ãƒ³ãƒˆå•é¡Œã®ãƒ•ãƒ©ã‚°
		let primeFlg = false; // ç´ æ•°å•é¡Œã®ãƒ•ãƒ©ã‚°
		let spotDiffFlg = false; // é–“é•ã„æ¢ã—å•é¡Œã®ãƒ•ãƒ©ã‚°
		let lastFlg = false; // æœ€çµ‚å•é¡Œã®ãƒ•ãƒ©ã‚°
		let lastIndex = 0; // æœ€çµ‚å•é¡Œã®è§£ç­”ãƒœã‚¿ãƒ³å€™è£œã®â™»ï¸ãƒœã‚¿ãƒ³ã«ã‚ˆã£ã¦å¤‰åŒ–ã™ã‚‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
		let flashTimerId; // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥å•é¡Œã®ã‚¿ã‚¤ãƒãƒ¼
		let darumaCount = 0; // ã ã‚‹ã¾å•é¡Œã®ã‚«ã‚¦ãƒ³ãƒˆ
		let darumaFlg = false; // ã ã‚‹ã¾å•é¡Œã®ãƒ•ãƒ©ã‚°
		let playerId = []; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼IDã‚’é…åˆ—ã«ã—ãŸã‚„ã¤ 
		let problems; // å•é¡Œé…åˆ—ã‚’å®šç¾©ã ã‘å…ˆã«ã™ã‚‹
		
		// çµŒéæ™‚é–“ï¼ˆç§’ï¼‰
		let time = 0;
		
		const lastList = [
		  ["1F", "2F", "3F", "4F", "5F", "6F", "7F", "8F", "â™»"],
		  ["9F", "10F", "11F", "12F", "13F", "14F", "15F", "16F", "â™»",],
		  ["17F", "18F", "19F", "20F","21F", "22F", "23F", "24F", "â™»",],
		  ["25F", "26F", "27F", "28F","29F", "30F", "31F", "32F", "â™»",],
		  ["33F","34F","35F","","","","","", "â™»"],
		  ["1","2","3","4","6","7","8","9", "â™»"]  
		];

		// é¬¼ãŒè¦‹ã‚‹ç¬é–“ï¼ˆæ­¢ã¾ã‚Œï¼ï¼‰
		const upperTimes = [3, 7, 10, 13, 19, 24, 29, 33, 36, 39, 45, 50, 55, 58, 61, 67, 72, 77, 80, 83, 89, 94, 99, 102, 105, 111, 116, 121, 124, 127, 133, 138, 143, 146, 149, 155, 160, 165, 168, 171, 177, 182, 187, 190, 193, 199, 204, 209, 212, 215, 221, 226, 231, 234, 237, 243, 248, 253, 256, 259, 265, 270, 275, 278, 281, 287, 292, 297, 300, 303, 309, 314, 319, 322, 325, 331, 336, 341, 344, 347, 353, 358, 363, 366, 369, 375, 380, 385, 388, 391, 397, 402, 407, 410, 413, 419, 424, 429, 432, 435, 441, 446, 451, 454, 457, 461, 466, 471, 475, 478];

		// é¬¼ãŒè¦‹ãªããªã‚‹ç¬é–“ï¼ˆå‹•ã‘ï¼ï¼‰
		const lowerTimes = [0,5, 8, 11, 15, 22, 26, 31, 34, 37, 41, 48, 51, 54, 58, 65, 68, 71, 75, 82, 85, 88, 92, 99, 102, 105, 111, 114, 117, 121, 128, 131, 134, 138, 145, 148, 151, 155, 162, 165, 168, 172, 179, 182, 185, 189, 196, 199, 202, 206, 213, 216, 219, 223, 230, 233, 236, 240, 247, 250, 253, 257, 264, 267, 270, 274, 281, 284, 287, 291, 298, 301, 304, 308, 315, 318, 321, 325, 332, 335, 338, 342, 349, 352, 355, 359, 366, 369, 372, 376, 383, 386, 389, 393, 400, 403, 406, 410, 417, 420, 423, 427, 434, 437, 440, 444, 451, 454, 457, 461, 468, 471, 474, 478, 479];

		// ãƒ•ãƒ©ã‚°ã®åˆæœŸçŠ¶æ…‹ï¼ˆå‹•ã‘ãªã„ï¼‰
		let canPush = false;


		// æ¯ãƒ•ãƒ¬ãƒ¼ãƒ æ›´æ–°é–¢æ•°
		function update() {
			

			// ã‚¿ã‚¤ãƒãƒ¼é–“éš”ï¼ˆç§’ï¼‰
			const interval = 0.1;
		    // ç§’å˜ä½ã§ã‚¿ã‚¤ãƒŸãƒ³ã‚°åˆ¤å®š
		    const currentSec = Math.floor(time);

		    if (upperTimes.includes(currentSec)) {
		        canPush = false;
		    } else if (lowerTimes.includes(currentSec)) {
		        canPush = true;
		    }


		    // çµŒéæ™‚é–“ã‚’é€²ã‚ã‚‹
		    time += interval;

		    // ä¾‹ãˆã°500ç§’ã¾ã§æ›´æ–°
		    if (time < 500) {
		        setTimeout(update, interval * 1000);
		    }
		}

		

		/** ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’è¡Œã†é–¢æ•°
		* @param {string} pcNum pcã®è­˜åˆ¥ç•ªå·(1~4)
		**/
		function startPolling(pcNum){
			console.log("ãƒãƒ¼ãƒªãƒ³ã‚°");
			if (pollingInterval !== null)return; //äºŒé‡èµ·å‹•é˜²æ­¢
			
			pollingInterval = setInterval(async() =>{
				const response = await fetch(`http://10.26.84.5:9910/api/PC/${pcNum}`);
				player = await response.json();
				if (player.qrid){
					startFlg = true
					startGamen.style.display = "block";
					clearInterval(pollingInterval);
					
					/* è§£ç­”ãƒœã‚¿ãƒ³ã®å—ä»˜
					*
					* æ“ä½œã‚’å—ã‘ä»˜ã‘ã¦ã„ã‚‹ã‹ã©ã†ã‹
					* åˆå›èµ·å‹•
					*
					*
					*/
					document.addEventListener("keydown",(event)=>{
						if(!canOperate)return; //æ“ä½œä¸å¯èƒ½ã ã£ãŸã‚‰ã“ã“ã§return
						const problem = problems[player.floor];
						
						// åˆå›èµ·å‹•å‡¦ç†
						if(startFlg){
							startFlg = false;
							startGamen.style.display = "none";
							let wait = 46000;
							if (player.tryCounts == 1){
								ruleVideo.src = "ãƒ«ãƒ¼ãƒ«èª¬æ˜.mp4";
								wait = 25000;
							}else if (player.tryCounts == 2){
								ruleVideo.src = "second_examination_third.mp4";
								wait = 12000;
							}else if (player.tryCounts >= 3){
								ruleVideo.src = "second_examination_forthikou.mp4";
								wait = 10000;
							}
							ruleVideo.load();
							startGame(wait);
							return;
						}
						// æœ€çµ‚å•é¡Œãƒ•ãƒ©ã‚°
						if (lastFlg){
							if (event.key == "9"){
								resetBoardLetters();
								lastIndex++;
								drawBoardLetters(lastList[lastIndex%6]);
								return;
							}
							if (lastIndex%6 != 5){
									
								if (["1","2","3","4","5","6","7","8"].includes(event.key)){
									if (lastIndex%6 == 4 && ["4","5","6","7","8"].includes(event.key)){
										return;
									}
									lastMove(event.key);
									if (player.floor == 32){
										trainCount.style.display = "block";
										trainCount.play();
									}
								}
								return;
							}else{
								changeSquareColor(changeNum(event.key)[0], changeNum(event.key)[1], "white",false); // æŠ¼ã—ãŸãƒœã‚¿ãƒ³ã®è‰²ã‚’å¤‰ãˆã‚‹

								// é‡è¤‡ãŒãªã„æ™‚ã ã‘è§£ç­”ãƒªã‚¹ãƒˆã«è¿½åŠ 
								if(!answerSet.has(event.key)){
									answerSet.add(event.key); 
									answerListSequence.push(event.key);
								}else{
								}

								// é †åºæŠ¼ã—ã®è¦ç´ æ•°ãŒè¦å®šã«é”ã—ãŸã‚‰
								if (answerListSequence.length == 4) {
									
									// æ­£èª¤åˆ¤å®š
									if (allCorrect(answerListSequence,["3","6","7","4"])) {
										resetSequence(); //ãƒªã‚»ãƒƒãƒˆ
										correctMusic.play(); // æ­£è§£éŸ³ã‚’å†ç”Ÿã™ã‚‹
										ruleVideo.pause();
										ruleVideo.style.display = "none";
										clear.style.display = "block";
										clear.play();
										// ä¸æ­£è§£å‡¦ç†
									} else {
										incorrect()
;										resetSequence();
									}
								}
								return;
							}

						}
						switch(problem.mode){
							case "single":{
								// éŸ³å‡ºã™ç³»ã®åˆå›èµ·å‹•
								if (player.floor === 16 && chakaFlg){
									canOperate = false;
									chakaFlg = false;
									message.textContent = "ç©ºç ²ã‚’æ•°ãˆã‚";
									chaka1.play();
									setTimeout(() => {
										canOperate = true;
										message.textContent = "ç­”ãˆã‚";
									},7000 );
									break;
								}else if (player.floor === 17 && chakaFlg2){
									canOperate = false;
									chakaFlg2 = false;
									message.textContent = "ç©ºç ²ã‚’æ•°ãˆã‚";
									chaka2.play();
									setTimeout(() => {
										canOperate = true;
										message.textContent = "ç­”ãˆã‚";
									},15000 );
									break;
								}else{
								}
								if (event.key === problem.answer) {
									correct();
								} else {
									incorrect();
									// é–“é•ã„æ¢ã—ã®æ™‚ã«èª¤ç­”ã§æ™‚é–“æ¸›å°‘ãƒšãƒŠãƒ«ãƒ†ã‚£
									if (spotDiffFlg){
										if (totalSeconds >= 30){
											ruleVideo.currentTime += 30;
										}else{
											ruleVideo.currentTime += totalSeconds;
										}
										totalSeconds -= 30;
									}
									// å¤±æ•—ã—ãŸæ™‚ã«ã‚‚ã†ä¸€å›å†ç”Ÿã™ã‚‹ã‚‚ã®ãŒã‚ã‚‹æ™‚
									if (player.floor == 16){
										canOperate = false;
										message.textContent = "ç©ºç ²ã‚’æ•°ãˆã‚";
										setTimeout(() => {
										  chaka1.play();
										}, 1000); 
										setTimeout(() => {
											canOperate = true;
											message.textContent = "ç­”ãˆã‚";
										},7000 );
									}else if (player.floor == 17){
										canOperate = false;
										message.textContent = "ç©ºç ²ã‚’æ•°ãˆã‚"
										setTimeout(() => {
										  chaka2.play();
										  setTimeout(() => {
										  	canOperate = true;
											message.textContent = "ç­”ãˆã‚";
										  },15000 );
										}, 1000); 
									}else if (crossFlg){
										canOperate = false;
										message.textContent = "xã‚’æ•°ãˆã‚";
										setTimeout(() => {
										  flashList(cross,300);
										}, 500); 
										setTimeout(() => {
											canOperate = true;
											message.textContent = "ç­”ãˆã‚";
										},7500); // ã“ã“ã¯ã¡ã‚ƒã‚“ã¨ç¢ºã‹ã‚ãŸã‹ã‚‰å¤§ä¸ˆå¤«
									}else if (primeFlg){
										canOperate = false;
										message.textContent = "ç´ æ•°ã‚’æ•°ãˆã‚";
										setTimeout(() => {
											flashList(prime,400);
										},500)
										setTimeout(() => {
											canOperate = true;
											message.textContent = "ç­”ãˆã‚";
										},9000);
									}
								}
								break;
							}
							case "all": {
								if (answerListAll[event.key - 1] === 0) {
									answerListAll[event.key - 1] = 1;
									fillSquareColor("red", event.key);
								} 

								if (allCorrect(problem.answer, answerListAll)) {
									correct();
								}
								break;
							}
							case "sequence": {
								
								// å‹•ç”»å•é¡Œã®åˆå›èµ·å‹•
								if (player.floor === 32 && trainFlg){
									canOperate = false;
									trainFlg = false;
									message.textContent = "ä¹—å®¢ã‚’æ•°ãˆã‚";
									trainCount.play();
									setTimeout(() => {
										canOperate = true;
										message.textContent = "ç­”ãˆã‚";
									},9000 );
									break;
								}
													
								changeSquareColor(changeNum(event.key)[0], changeNum(event.key)[1], "white"); // æŠ¼ã—ãŸãƒœã‚¿ãƒ³ã®è‰²ã‚’å¤‰ãˆã‚‹
								
								// é‡è¤‡ãŒãªã„æ™‚ã ã‘è§£ç­”ãƒªã‚¹ãƒˆã«è¿½åŠ 
								if(!answerSet.has(event.key)){
									// éŸ³éšå•é¡Œã§éŸ³ã‚’å†ç”Ÿã™ã‚‹
									if (pianoFlg){
										piano(event.key);
									}
									answerSet.add(event.key); 
									answerListSequence.push(event.key);
								}else{
									// ç™½ã§å¡—ã‚‹å•é¡Œ
									if (doubleFlg){
										canOperate = false;
										setMainImage("ã‚·ãƒ§ãƒ¼ãƒˆã‚±ãƒ¼ã‚­(ç™½ã‚ã‚Š).png");
										setTimeout(() => {
											correct();
											canOperate = true;
										},500);
									}
								}
								
								// é †åºæŠ¼ã—ã®è¦ç´ æ•°ãŒè¦å®šã«é”ã—ãŸã‚‰
								if (answerListSequence.length === problem.yobi1) {
									
									// æ­£èª¤åˆ¤å®š
									if (allCorrect(answerListSequence,problem.answer)) {
										resetSequence(); //ãƒªã‚»ãƒƒãƒˆ
										correct();
										// ä¸æ­£è§£å‡¦ç†
									} else {
										resetSequence();
										// ç‚¹æ»…å•é¡Œãƒ¬ãƒ™ãƒ«1
										if (flash1Flg){
											flash([2,7,6,9,1,3,8,5,4],5500);
										}
										incorrect();
										// ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æš—ç®—
										if (flashCulcFlg){
											document.getElementById("message").textContent = "è¶³ã›";
											canOperate = false;
											setTimeout(()=>{
												flashProb(problem);
											},500);
											setTimeout(()=>{
												// fix æ™‚é–“ãŒæ€ªã—ã„
												document.getElementById("message").textContent = "ç­”ãˆã‚";
												canOperate = true;
											},5000);
										}
										if (flashMemoFlg){
											message.textContent = "è¦šãˆã‚";
											canOperate = false;
											setTimeout(()=>{
												flashList(problem.flashList,500);
											},500);
											setTimeout(()=>{
												// fix æ™‚é–“ãŒæ€ªã—ã„
												message.textContent = "ç­”ãˆã‚";
												canOperate = true;
											},5000);
										}
										if (player.floor == 32){
											canOperate = false;
											trainFlg = false;
											message.textContent = "ä¹—å®¢ã‚’æ•°ãˆã‚";
											trainCount.play();
											setTimeout(() => {
												canOperate = true;
												message.textContent = "ç­”ãˆã‚";
											},12000 );
											break;
										}
										 if (player.floor == 30){
											canOperate = false;
											flashList(problem.yobi2,500);
											setTimeout(() => {
												canOperate = true;
											},3000); // ã“ã“ã‚‚ã¡ã‚ƒã‚“ã¨ç¢ºã‹ã‚ãŸ
										 }
									}
								}
								break;
							}
							case "simul": {
								if (!answerSet.has(event.key)){
									answerSet.add(event.key); // åŒã˜ã‚­ãƒ¼ã¯å—ã‘ä»˜ã‘ãªã„ã‚ˆã†ã«ã™ã‚‹
								}
								if (fruitFlg){
									// ãƒ•ãƒ«ãƒ¼ãƒ„å•é¡Œã®è‰²å¤‰æ›´å‡¦ç†
									if (event.key === "1"){
										center.textContent = "ğŸ";
									}else if (event.key === "3"){
										center.textContent = "ğŸ«";
									}else if (event.key === "7"){
										center.textContent = "ğŸ¥";
									}else if (event.key === "9"){
										center.textContent = "ğŸŒ";
									}
									
								}
								if (answerSet.size == problem.answer[simulSequenceCount].size){ // ã‚»ãƒƒãƒˆã®è¦ç´ æ•°ãŒä¸€è‡´ã—ãŸã‚‰
									if(isEqualSet(problem.answer[simulSequenceCount],answerSet)){ // æ­£èª¤åˆ¤å®š
										// åŒæ™‚æŠ¼ã—é€£ç¶šå•é¡Œ(ç‚¹æ»…ãƒ¬ãƒ™ãƒ«2ä»¥é™ã¨ã‹)
										if (simulSequenceFlg){
											simulSequenceCount++; // æ­£è§£æ•°ã‚’ãƒ—ãƒ©ã‚¹
											if (problem.yobi1 === simulSequenceCount){
												correct();
											}else{
												new Audio("æ±ºå®šéŸ³.mp3").play(); // ãƒŸãƒ‹æ­£è§£éŸ³
											}
										}else if(fruitFlg) {
											center.textContent = "ğŸ‡";
											canOperate = false;
											setTimeout(() => {
												correct();
												canOperate = true;
											},500);
										}else{
											 //ãŸã ã®åŒæ™‚æŠ¼ã—å•é¡Œã®æ™‚ã®æ­£è§£å‡¦ç†
											correct();
										}
									}else{
										if (flash2Flg){
											document.getElementById("message").textContent = "è¦šãˆã‚";
											canOperate = false;
											simulSequenceCount = 0;
											setTimeout(()=>{
												blinkSequence(["1","5","1","1"]);
												blinkSequence(["2","6","4","2"]);
												blinkSequence(["5","7","6","3"]);
												blinkSequence(["9","8","9","5"]);
											},1000);
											setTimeout(()=>{
												document.getElementById("message").textContent = "é †ã«æŠ¼ã›";
												canOperate = true;
											},3300);
										}
									}
									answerSet.clear(); // ã‚»ãƒƒãƒˆã‚‚ãƒªã‚»ãƒƒãƒˆ
								}
								break;
								
							}
							case "allMap": {
								let tempVal = moving(event.key);
								if (specStrokeFlg){ 
									while (tempVal){
										tempVal = moving(event.key);
									}
								}
								break;
							}
							case "set" : {
								// æ±ºå®šãƒœã‚¿ãƒ³æ‰±ã„
								if (event.key === "5"){
									if (isEqualSet(userSet,problem.answer)){
										correct();
									}else{
										incorrect();
										resetSqareColor(); // æ­£æ–¹å½¢ã®è‰²ã‚’ãƒªã‚»ãƒƒãƒˆ
										// è§£ç­”ãƒœã‚¿ãƒ³ã«æ–‡å­—ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’å†æç”»
										if (boardFlg){
											drawBoardLetters(problems[player.floor].squareList);
										}
										userSet.clear();
									}
								}else{
									changeSquareColor(changeNum(event.key)[0], changeNum(event.key)[1], "white");
									if (event.key === "1"){
										if (userSet.has("1")){
											userSet.add("11");
											changeSquareColor(changeNum(1)[0],changeNum(2)[1],"yellow");
										}
									}
									userSet.add(event.key);
								}
								break;
								
							}
							case "circle" : {
								if (event.key === "4"){
									if (player.floor == 19){
										fillACircle();
										circleStates[0] = 1;
										if (circleStates.every(v => v === 1)) {
										    correct();
										}
									}else if (player.floor == 25){
										circleStates[0] = timeProb();
										fillCircleByIndex(0,problem.colors[timeProb()]);
										if (allCorrect(circleStates,problem.answer)){
											correct();
										}
									}
								}else if (event.key === "5"){
									rotateCircle();
									if (allCorrect(circleStates,problem.answer)){
										correct();
									}
								}
								break;
							}
							case "sum" : {
								sumCount += (totalSeconds%60);
								center.textContent = sumCount;
								if (sumCount % 1000 == 0){
									canOperate = false;
									setTimeout(()=>{
										correct();
									},500);
								}
								break;
							}
							case "perfect" : {
								if (problem.answer[tempIndex] === event.key){
									// ã—ã‚‡ã¼ã‚ãªæ­£è§£éŸ³
									new Audio("æ±ºå®šéŸ³.mp3").play(); // ãƒŸãƒ‹æ­£è§£éŸ³
									useMainImageList(rainbowImageList,event.key);
									
									tempIndex++;
									if (tempIndex === problem.yobi1){
										correct();
										tempIndex = 0; // ãƒªã‚»ãƒƒãƒˆ
									}
								}else{
									incorrect();
									tempIndex = 0; // ãƒªã‚»ãƒƒãƒˆ
									setMainImage("tower_6th_rainbow/1color.png");
								}
								break;
							}
							case "daruma" : {
								if (darumaFlg){
									message.textContent = "100ã‚’ç›®æŒ‡ã›";
									darumaFlg = false;
									daruma.style.display = "block";
									update();
									daruma.play();
									sub.textContent = darumaCount;
									break;
								}
								if (canPush){
									darumaCount++;
									sub.textContent = darumaCount;
									if (darumaCount == 100){
										correct();
									}
								}else{
									incorrect();
									darumaCount = 0;
									sub.textContent = darumaCount;
									time = 0;
									daruma.currentTime = 0;
									daruma.play();
								}
							}

						}
						
					}); 


					/* è§£ç­”ãƒœã‚¿ãƒ³ã‚’é›¢ã—ãŸæ™‚ã®å‡¦ç†
					*
					*/
					document.addEventListener("keyup",(event)=>{
						switch (problems[player.floor].mode){
							case "simul":{

								answerSet.delete(event.key); // è©²å½“ã‚­ãƒ¼ã‚’å‰Šé™¤
								
							} 
						}
					});
				

					/*
					* å•é¡Œç®¡ç†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒªã‚¹ãƒˆ
					* néšã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹nã«æ ¼ç´ã•ã‚Œã¦ã„ã‚‹
					*/
					problems = [
					{},
					{
						number : 1,
						mode : "single",
						answer : "1",
						message : "æŠ¼ã›"
					},
					{
						number : 2,
						mode : "all",
						answer : [1,1,1,1,1,1,1,1,1],
						message : "å¡—ã‚Šã¤ã¶ã›"
					},
					{
						number : 3,
						mode : "sequence",
						answer : ["3","6","9","1","7","2","5","4","8"],
						message : "é †ã«æŠ¼ã›",
						yobi1 : 9 // é€£ç¶šæŠ¼ã—ã®æœ€å¤§å›æ•°
					},
					{
						number : 4,
						mode : "sequence",
						answer : ["2","7","6","9","1","3","8","5","4"],
						message : "é †ã«æŠ¼ã›",
						yobi1 : 9
					},
					{
						number : 5,
						mode : "simul",
						answer :[new Set(["4","5","6"])],
						message : "æŠ¼ã›",
					},
					{
						number : 6,
						mode : "allMap",
						answer : Array.from({ length: 8 }, () => Array(10).fill(1)),
						message : "ä¸€ç­†ã§æ›¸ã‘",
						map : level1Map
					},
					{
						number : 7,	
						mode : "sequence",
						answer : ["7","8","4","3","6"],
						message : "é †ã«æŠ¼ã›",
						squareList : ["O", "J", "W", "T", "D", "F", "S", "M","P"],
						yobi1 : 5
					},
					{
						number : 8,
						mode : "sequence",
						answer : ["2","7","6","9","1","3","8","5","4"],
						message : "é †ã«æŠ¼ã›",
						yobi1 : 9
					},
					{
						number : 9,
						mode : "single",
						answer : "7",
						message : "é–“é•ã„ã‚’æ¢ã›(èª¤ç­”ã¯-30ç§’)",
						squareList : ["1","2","3","4","5","6","7","8","9"]
						
					},
					{
						number : 10,
						mode : "allMap",
						answer : Array.from({ length: 8 }, () => Array(10).fill(1)),
						message : "ä¸€ç­†ã§æ›¸ã‘",
						map : level2Map
					},
					{
						number : 11,
						mode : "simul",
						answer : [new Set(["1","2","5","9"]),new Set(["5","6","7","8"]),new Set(["1","4","6","9"]),new Set(["1","2","3","5"])],
						message : "è¦šãˆã‚",
						yobi1 : 4 // ä½•å€‹é€£ç¶šã§æŠ¼ã•ã›ã‚‹ã‹
					},
					{
						number : 12,
						mode : "sequence",
						answer :  ["2","1","4","8","7","6","5","9","3"],
						message : "é †ã«æŠ¼ã›",
						yobi1 : 9
					},
					{
						number : 13,
						mode : "sequence",
						answer : ["2","6","8","1","7","9","3","5"],
						message : "é †ã«æŠ¼ã›",
						yobi1 : 8,
						squareList : ["A", "J", "N", "T", "D", "F", "S", "M", "O"]
					},
					{
						number : 14,
						mode : "sequence",
						answer : ["8","3","2","1","9","7"],
						message : "é †ã«æŠ¼ã›",
						yobi1 : 6
					},
					{
						number : 15,
						mode : "set",
						answer : new Set(["1","2","4","6","7","8","11"]), // ã‚¬ãƒã ã‘ã©1ã¯ç­”ãˆã˜ã‚ƒãªã„ã®ã«å…¥ã£ã¡ã‚ƒã†ã‘ã©ã‚‚ã†è¨±å®¹
						message :"ç•°å¤‰ãŒã‚ã‚‹æœˆã‚’å…¨ã¦æŠ¼ã›",
						squareList : ["1","2","3","4","æ±º","6","7","8","9"]
					},
					{
						number : 16,
						mode : "single",
						answer : "7",
						message : "ãƒœã‚¿ãƒ³ã‚’æŠ¼ã›",
						squareList : ["1","2","3","4","5","6","7","8","9"]
					},
					{
						number : 17,
						mode : "single",
						answer : "4",
						message : "ãƒœã‚¿ãƒ³ã‚’æŠ¼ã›",
						squareList : ["1","2","3","4","5","6","7","8","9"]
					},
					{
						number : 18,
						mode : "sequence",
						answer : ["5","9","7","6","4","3","8","1","2"],
						message : "é †ã«æŠ¼ã›",
						yobi1 : 9
					},
					{
						number : 19,
						mode : "circle",
						answer : "",
						message : "å…¨ã¦ç¯ã›",
						colors : ["red"]
					},
					{
						number : 20,
						mode : "sum",
						answer : "",
						message : "1000ã®å€æ•°ã«ã—ã‚"
					},
					{
						number : 21,
						mode : "sequence",
						answer : "",
						message : "å¡—ã‚Œ",
						yobi1 : 9
					},
					{
						number :22,		
						mode : "sequence",
						message : "å¥ã§ã‚",
						answer : ["4","8","1","7","3","2","6","5"],
						yobi1 : 8
					},
					{
						number : 23,
						mode : "sequence",
						answer : [],
						yobiAnswer : [ ["9","2","6","5","1"],["4","3","2","5"],["3","9","5"],["2","7"],["7"] ],
						message : "è¶³ã›",
						squareList : ["1","2","3","4","5","6","7","8","9"],
						yobi1 : 0,
						yobi2 : [ ["16123","14567","15200","16010","14890","15861",""],["619","893","532","781","777","723",""],["67","92","41","73","58","64",""],["3","7","6","2","4","5",""],["1","0","1","2","1","2",""] ]
					},
					{
						number : 24,
						mode : "simul",
						answer : [new Set(["1","3"])],
						message : "è‘¡è„ã‚’æã‘"
					},
					{
						number : 25,
						mode : "circle",
						answer : [2,3,1,4],
						message : "æƒãˆã‚",
						colors : ["","red","blue","green","yellow","white"]
					},
					{
						number : 26,
						mode : "sequence",
						answer : ["5","8","3","2","9","4","1","6","7"],
						message : "è¦šãˆã‚",
						flashList : ["5","8","3","2","9","4","1","6","7",""],
						squareList : ["1","2","3","4","5","6","7","8","9"],
						yobi1 : 9
					},
					{
						number : 27,
						mode : "perfect",
						answer : ["4","6","2","5","1","3"],
						message : "æã‘",
						yobi1 : 6
					},
					{
						number : 28,
						mode : "single",
						message : "xã‚’æ•°ãˆã‚",
						answer : "1",
						squareList : ["1","2","3","4","5","6","7","8","9"]
					},
					{
						number : 29,
						mode : "allMap",
						answer : Array.from({ length: 8 }, () => Array(10).fill(1)),
						message : "è§£ã‘",
						map : specMap
					},
					{
						number :30,
						mode : "sequence",
						message : "ç¶šãã‚’ç´¡ã’",
						answer : playerId,
						yobi1 : 4,
						yobi2 : ["1423","5903","9209","5434","0390",""],
						squareList : ["1","2","3","4","5","6","7","8","9"]
						
					},
					{
						number : 31,
						mode : "sequence",
						message : "å­¤ç«‹ã‚’æ¢ã›",
						answer : ["4","9"],
						yobi1 : 2,
						squareList : ["1","2","3","4","5","6","7","8","9"]
					},
					{
						number : 32,
						mode : "sequence",
						message : "æŠ¼ã›",
						answer : ["2","5"],
						yobi1 : 2,
						squareList : ["1","2","3","4","5","6","7","8","9"]
					},
					{
						number : 33,
						mode : "daruma",
						message : "æŠ¼ã›",
					},
					{
						number : 34,
						mode : "single",
						message : "ç´ æ•°ã‚’æ•°ãˆã‚",
						answer : "7",
						squareList : ["1","2","3","4","5","6","7","8","9"]
					},
					{
						number : 35,
						mode : "last",
						message : "â™ ï¸â™£ï¸â¤â™¦ï¸ï¸",
						answer : ""
					}
					];
				}else{
				}
				
				
			},3000) //3ç§’ã”ã¨ã«ç¢ºèª
		}
		
		/**
		 * é…åˆ—ã‚’å³ã«å›è»¢ã•ã›ã‚‹
		 * @param {number} times - å›è»¢å›æ•°ï¼ˆçœç•¥ã§1å›ï¼‰
		 * @returns {boolean[]} å›è»¢å¾Œã®é…åˆ—
		 */
		function rotateArray(times = 1) {
		    const len =circleStates.length;
		    times = times % len; // ä½™åˆ†ãªå›è»¢ã¯ç„¡è¦–
			circleStates = circleStates.slice(-times).concat(circleStates.slice(0, len - times));
		}
		
		/** å††ã‚’èµ¤ãå¡—ã‚‹
		*
		*/
		function fillACircle(){
			fillCircleByIndex(0,"red");
		}
		
		/** ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã™ã‚‹é–¢æ•°
		*
		*/
		function startGame(wait){
			player.tryCounts++; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æŒ‘æˆ¦å›æ•°ã‚’+1
			canOperate = false;
			ruleVideo.play();
			ruleVideo.style.display = "block";
			// 30å•ç›®ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
			// æ•°å­—ã‚’æ–‡å­—åˆ—ã¨ã—ã¦æ‰±ã†
			const str = String(player.qrid);
			// 1æ¡ãšã¤ã®é…åˆ—ã«å¤‰æ›ï¼ˆæ•°å€¤ã®é…åˆ—ã«ã—ãŸã„å ´åˆã¯ map(Number) ã‚’è¿½åŠ ï¼‰
			playerId = str.split("");
			problems[30].answer = playerId;
			setTimeout(() => {
				canOperate = true;
				ruleVideo.style.display = "none";
				setTimer(); //ã‚¿ã‚¤ãƒãƒ¼ã‚’èµ·å‹•
				drawGrid();
				changeFloor(); // ãã®éšå±¤ã®åˆæœŸå‡¦ç†ã‚’è¡Œã†
				updateScreen();
			},wait);

		}
		/** ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ™‚ã®å‡¦ç†
		*
		*/
		function endGame(){
			canOperate = false;
			
			
			fetch("http://10.26.84.5:9910/api/player",{
				method:"POST",
				headers:{"Content-Type":"application/json","Accept": "application/json",},
				body: JSON.stringify(player)
			});
			fetch("http://10.26.84.5:9910/api/calcScore",{
				method:"POST",
				headers:{"Content-Type":"application/json","Accept": "application/json",},
				body: JSON.stringify(player)
			}).then(response => response.json())
			.then(data => {
				console.log("ãƒ‡ãƒãƒƒã‚°");
				
				ruleVideo.style.display = "block";
				setTimeout(() => {
					ruleVideo.style.display = "none";
					if (data.playerRank == "S"){
						document.getElementById("playerRankS").style.display = "block";
					}else if (data.playerRank == "A+"){
						document.getElementById("playerRankA+").style.display = "block";
					}else if (data.playerRank == "A"){
						document.getElementById("playerRankA").style.display = "block";
					}else if (data.playerRank == "B"){
						document.getElementById("playerRankB").style.display = "block";
					}else{
						document.getElementById("playerRankC").style.display = "block";
					}
					resultFloor.textContent = data.floor;
					resultFloor.style.display = "block";
					
					ranking.textContent = data.ranking;
					ranking.style.display = "block";
					
					tryCount.textContent = player.tryCounts;
					tryCount.style.display = "block";
					
					total.textContent = data.totalPlayer;
					total.style.display = "none";
				},7000);
				setTimeout(() => {
					exit.style.zIndex = 15000;
					exit.style.display = "block";
				},15000)
				setTimeout(() => {
				    fetch(`http://10.26.84.5:9910/api/reset/${pcNum}`, {
				        method: "POST",
				        headers: {
				            "Content-Type": "application/json",
				            "Accept": "application/json",
				        },
				    })
				    .then(response => {
				        if (!response.ok) throw new Error("Fetch failed");
				    })
				    .then(() => {
				        // fetchæˆåŠŸæ™‚ã®ã¿ãƒªãƒ­ãƒ¼ãƒ‰
				        location.reload();
				    })
				    .catch(err => {
				        console.error("PCUsing POST failed:", err);
				    });
				}, 30000);

			});
			
			
		}
		
		/**
		*
		*/
		function complete(){
			ruleVideo.style.display = "none";
		}
		
		/** ã‚¿ã‚¤ãƒãƒ¼ã‚’ç®¡ç†ã™ã‚‹é–¢æ•°
		*
		*/
		function setTimer(){
			let isValid = true;
			totalSeconds = 480; // åˆ¶é™æ™‚é–“ã‚’ç§’æ•°ã§
			const timerElem = document.getElementById('timer');

			function formatTime(seconds) {
			  const m = Math.floor(seconds / 60);
			  const s = seconds % 60;
			  return m + ':' + (s < 10 ? '0' + s : s);
			}

			timerElem.textContent = formatTime(totalSeconds);

			const intervalId = setInterval(() => {
			  totalSeconds--;
			  timerElem.textContent = formatTime(totalSeconds);

			},1000);
			
			const endGameIntervalId = setInterval(() => {
				// ã‚¿ã‚¤ãƒ ã‚ªãƒ¼ãƒãƒ¼ã®æ™‚ã®å‡¦ç†
				if (totalSeconds <= 0) {
				clearInterval(intervalId);
				clearInterval(endGameIntervalId);
				endGame();
				}
			},50);
		}
		
		/** ç”»é¢æ›´æ–°é–¢æ•°
		* éšå±¤ã¨å•é¡Œæ–‡ã®æ›´æ–°ã‚’è¡Œã†
		*/
		function updateScreen(){
			floor.textContent = player.floor;
			message.textContent = problems[player.floor].message;
		}
		
		
		/** æ­£è§£æ™‚ã®é€²è¡Œé–¢æ•°
		*
		*/
		function correct(){
			canOperate = false;
			player.floor += 1;
			correctMusic.play(); // æ­£è§£éŸ³ã‚’å†ç”Ÿã™ã‚‹
			updateScreen(); // éšå±¤ã¨å•é¡Œæ–‡ã®æ›´æ–°
			changeScreen(); // ç”»é¢é·ç§»é–¢æ•°ã®å‘¼ã³å‡ºã—

			
		}
		/** ä¸æ­£è§£æ™‚ã®é€²è¡Œé–¢æ•°
		*
		*/
		function incorrect(){
			incorrectMusic.play(); // ä¸æ­£è§£éŸ³é³´ã‚‰ã™
		}
		
		/** ç”»é¢é·ç§»ã‚’å‘¼ã³å‡ºã™é–¢æ•°
		*
		*/
		function changeScreen(){
			transition.style.display = "block";
			canOperate = false;
			setTimeout(()=>{
				moveMusic.play(); // ç§»å‹•éŸ³
			},500);
			setTimeout(()=>{
				transition.style.display = "none";
				canOperate = true;
				drawGrid();
				changeFloor(); // å•é¡Œæç”»å¤‰æ›´å‡¦ç†é–¢æ•°ã®å‘¼ã³å‡ºã—
			},1000);
		}
			
		
		/** è§£ç­”ãƒœã‚¿ãƒ³ã®è‰²ã‚’ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹å‡¦ç†
		* @param {*} flg 
		*/
		function resetSqareColor(flg = true){
			for (let i = 0; i < 3 ; i++){
				for (let j = 0 ; j < 3 ;j++){
					clearSquareColor(i,j,flg);
				}
				
			}
		}
		
		/** éšå±¤ç§»å‹•æ™‚ã®å…±é€šå‡¦ç†
		*
		*/
		function changeFloorUtil() {
			simulSequenceCount = 0 ;
			clearInterval(flashTimerId); // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥å†ç”Ÿã‚’æ­¢ã‚ã‚‹
			center.textContent = ""; // è¡¨ç¤ºã‚’æ¶ˆã™
			sub.textContent = ""; // ä¸‹éƒ¨ã®è¡¨ç¤ºã‚’æ¶ˆã™
			main.style.display = "none"; // å•é¡Œç”»åƒã‚’éè¡¨ç¤º
			resetSqareColor(); // è§£ç­”ãƒœã‚¿ãƒ³ã®ã®å¡—ã‚Šæ½°ã—ã‚’å‰Šé™¤
			resetBoardLetters(); // è§£ç­”ãƒœã‚¿ãƒ³ã®æ–‡å­—ã‚’å‰Šé™¤
			clearInterval(blinkInterval); // æ­£æ–¹å½¢ã®ç‚¹æ»…ã‚’åœæ­¢
			ctx.clearRect(0, 0, canvas.width, canvas.height); // ç”»é¢å…¨ä½“ã‚’æ¶ˆå»
			drawGrid(); // è§£ç­”ãƒœã‚¿ãƒ³ã‚’å†æç”»
		}
		
		/** Canvasã‚’ãƒªã‚»ãƒƒãƒˆã—è§£ç­”ãƒœã‚¿ãƒ³ã‚’æç”»
		* 
		*/
		function drawGrid() {
		  ctx.beginPath();
		  for (let i = 0; i <= n; i++) {
		    // ç¸¦ç·š
		    ctx.moveTo(offsetX + i * size, offsetY);
		    ctx.lineTo(offsetX + i * size, offsetY + n * size);

		    // æ¨ªç·š
		    ctx.moveTo(offsetX, offsetY + i * size);
		    ctx.lineTo(offsetX + n * size, offsetY + i * size);
		  }
		  ctx.strokeStyle = "black";
		  ctx.stroke();
		}
		
		/** å•é¡Œã¨ã—ã¦è¡¨ç¤ºã™ã‚‹æ­£æ–¹å½¢ã‚’æç”»ã™ã‚‹
		* æœ¬æ¥ã¯å¤‰æ•°ã«ã—ãŸã„ã‘ã©ä¸€å›ä¿ç•™ã§
		*/
		function makeSquare(){
			ctx.moveTo(850,500);
			ctx.lineTo(850,695);
			ctx.lineTo(1045,695);
			ctx.lineTo(1045,500);
			ctx.lineTo(850,500);
			ctx.strokeStyle = "white";
			ctx.stroke();
		}
		
		/** å•é¡Œã¨ã—ã¦è¡¨ç¤ºã™ã‚‹æ­£æ–¹å½¢ã‚’å¡—ã‚‹é–¢æ•°
		*
		*
		*/
		function fillSquareColor(color,num){
			ctx.fillStyle = color;
			let X = 850+65*changeNum(num)[0] ;
			let Y = 500+65*changeNum(num)[1] ;
			ctx.fillRect(X,Y,65,65);
		}
		
		/**
		 * ä¸€ç­†æ›¸ãå•é¡Œã«ä½¿ç”¨ã™ã‚‹æ­£æ–¹å½¢ã‚’æç”»ã™ã‚‹
		 */
		function makeSquaresGrid(rows){
		    const size = 50; // å…ƒã®1è¾ºã‚’1.8å€
		    const startX = 650;
		    const startY = 300;
		    const cols = 10;
		    const gap = 5; // éš™é–“ï¼ˆå¿…è¦ã«å¿œã˜ã¦èª¿æ•´ï¼‰

		    ctx.strokeStyle = "white";

		    for(let row = 0; row < rows; row++){
		        for(let col = 0; col < cols; col++){
		            const x = startX + col * (size + gap);
		            const y = startY + row * (size + gap);
		            ctx.beginPath();
		            ctx.rect(x, y, size, size);
		            ctx.stroke();
		        }
		    }
		}
		
		/** ä¸€ç­†æ›¸ãã®æ­£æ–¹å½¢ã‚’å¡—ã‚Šã¤ã¶ã™
		*
		*/
		function fillSquare(x, y, color){
		    const size = 50;
		    const startX = 650;
		    const startY = 300;
		    const cols = 10;
		    const rows = 8;
		    const gap = 5;

		    const drawX = startX + x * (size + gap);
		    const drawY = startY + y * (size + gap);

		    ctx.fillStyle = color;
		    ctx.fillRect(drawX, drawY, size, size);
		}
		
		/** äºŒã¤ã®ã‚»ãƒƒãƒˆã®å†…å®¹ãŒç­‰ã—ã„ã‹ã‚’æ¯”è¼ƒã™ã‚‹
		*
		*/
		function isEqualSet(setA, setB) {
		    if (setA.size !== setB.size) return false; // è¦ç´ æ•°ãŒé•ã†æ™‚ç‚¹ã§NG
		    for (let elem of setA) {
		        if (!setB.has(elem)) return false; // ç‰‡æ–¹ã«ã—ã‹ãªã„è¦ç´ ãŒã‚ã‚Œã°NG
		    }
		    return true; // å…¨éƒ¨ä¸€è‡´
		}


		
		/** è§£ç­”ãƒœã‚¿ãƒ³ã®ç•ªå·ã‚’(å·¦ã‹ã‚‰0,1,2 , ä¸Šã‹ã‚‰0,1,2)ã«å¤‰æ›´ã™ã‚‹å‡¦ç†
		* @param {num} 1~9ã®è§£ç­”ãƒœã‚¿ãƒ³ç•ªå·
		*/
		function changeNum(num){
			let ret = [];
			let x;
			let y;
			if (num == 1){
			    x = 0; y = 0;
			} else if (num == 2){
			    x = 1; y = 0;
			} else if (num == 3){
			    x = 2; y = 0;
			} else if (num == 4){
			    x = 0; y = 1;
			} else if (num == 5){
			    x = 1; y = 1;
			} else if (num == 6){
			    x = 2; y = 1;
			} else if (num == 7){
			    x = 0; y = 2;
			} else if (num == 8){
			    x = 1; y = 2;
			} else if (num == 9){
			    x = 2; y = 2;
			} else {
			    throw new Error("numã¯1ï½9ã§æŒ‡å®šã—ã¦ãã ã•ã„");
			}
			ret.push(x);
			ret.push(y);
			return ret;
			

		}
		
		/** æœ€çµ‚å•é¡Œã§éšå±¤ç§»å‹•ã‚’ã™ã‚‹é–¢æ•°
		*
		*/
		function lastMove(key){
			if (lastIndex%6 == 5){
				if (Number(key) > 2){
					return;
				}
			}
			if (lastIndex%6 < 5){
				player.floor = 8*(lastIndex%6) + Number(key);
				updateScreen(); // éšå±¤ã¨å•é¡Œæ–‡ã®æ›´æ–°
				changeScreen(); // ç”»é¢é·ç§»é–¢æ•°ã®å‘¼ã³å‡ºã—
				
			}
		}
			
		/** èƒŒæ™¯ç”»åƒã‚’ãƒ¢ãƒ‹ã‚¿ãƒ¼ã‚µã‚¤ã‚ºã«èª¿æ•´ã™ã‚‹é–¢æ•°
		* kioskãƒ¢ãƒ¼ãƒ‰ã«ã—ãŸæ™‚ãªã©ã«æœ€å¤§åŒ–ã™ã‚‹å‰ã®å¤§ãã•ã«åˆã‚ã›ã‚‰ã‚Œã¦ã—ã¾ã†ã“ã¨ã«æ³¨æ„ã€‚ç”»é¢ã‚’æœ€å¤§åŒ–ã—ãŸä¸Šã§ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒå¿…è¦
		* 
		*/
		function resizeBackground() {
		    const html = document.documentElement;
		    const body = document.body;

		    // å®Ÿéš›ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºã«åˆã‚ã›ã‚‹
		    const w = window.innerWidth;
		    const h = window.innerHeight;

		    html.style.width = w + "px";
		    html.style.height = h + "px";

		    body.style.width = w + "px";
		    body.style.height = h + "px";

		    // èƒŒæ™¯è¨­å®š
		    body.style.backgroundRepeat = "no-repeat";
		    body.style.backgroundSize = "100% 100%";  // å·¦ä¸Šå›ºå®šã§ç”»é¢ã„ã£ã±ã„
		    body.style.backgroundPosition = "left top";
		}
		resizeBackground();	
		
		/** æŒ‡å®šã•ã‚ŒãŸãƒã‚¹ã‚’æŒ‡å®šã•ã‚ŒãŸè‰²ã§å¡—ã‚Šã¤ã¶ã™é–¢æ•°
		* 
		* X,Yåº§æ¨™ã¯tempå€¤
		* @param {number} x - å·¦ã‹ã‚‰0,1,2ç•ªç›®ã®æ­£æ–¹å½¢
		* @param {number} y - ä¸Šã‹ã‚‰0,1,2ç•ªç›®ã®æ­£æ–¹å½¢ 
		*/
		function changeSquareColor(x , y,color , flg = true){
			if (flg){
				if (lastFlg){
					return;
				}
			}

			ctx.fillStyle = color;
			let X = offsetX+size*x +2; // offsetã«æ­£æ–¹å½¢ã®åˆ†ã‚’è¶³ã™
			let Y = offsetY+size*y +2;
			ctx.fillRect(X,Y,size-4,size-4);
			
		}
		
		/** ç‚¹æ»…ã•ã›ã‚‹é–¢æ•°
		*
		*/
		function blink(x,y,color){
			changeSquareColor(x,y,color);
			setTimeout(()=>{
				clearSquareColor(x,y);
			},400)
		}
		
		/**
		 * 1ï½9ã®ãƒã‚¹ã‚’é †ç•ªã«ç‚¹æ»…ã•ã›ã‚‹é–¢æ•°
		 * @param {number[]} sequence - ç‚¹æ»…ã•ã›ãŸã„ãƒã‚¹ç•ªå·ã®é…åˆ— (ä¾‹: [1,2,3,4,5,6,7,8,9])
		 * @param {number} interval - æ¬¡ã®ãƒã‚¹ãŒç‚¹æ»…ã™ã‚‹ã¾ã§ã®å¾…æ©Ÿæ™‚é–“(ms)
		 */
		function blinkSequence(sequence, interval = 500) {
		    sequence.forEach((num, index) => {
		        // setTimeout ã§é †ç•ªã«å‡¦ç†
		        setTimeout(() => {
		            const [x, y] = changeNum(num); // ãƒã‚¹ç•ªå· â†’ x,y
		            changeSquareColor(x, y, "white"); // ç™½ã§å¡—ã‚‹
		            setTimeout(() => {
		                clearSquareColor(x, y); // å°‘ã—å¾…ã£ã¦é€æ˜ã«æˆ»ã™
		            }, interval / 2); // åŠåˆ†ã®æ™‚é–“ã§æ¶ˆãˆã‚‹
		        }, interval * index);
		    });
		}
		
		/** è§£ç­”ãƒœã‚¿ãƒ³ã®è‰²ã‚’æ¶ˆã™
		* æ­£æ–¹å½¢ã®è‰²ã‚’æ¶ˆã™
		* ä½¿ã„æ–¹ã¯changeSquareColorã‚’å‚ç…§
		*/
		function clearSquareColor(x,y,spec = true){
			if (spec){
				if (lastFlg){
					return;
				}
			}
			let X = offsetX+size*x +2;
			let Y = offsetY+size*y +2;
			ctx.clearRect(X,Y,size -4,size -4);
		}
		
		/** modeãŒallã®æ™‚ã«äºŒã¤ã®ãƒªã‚¹ãƒˆã‚’é †åºã‚’å®ˆã‚ŠãªãŒã‚‰æ¯”è¼ƒã™ã‚‹
		*
		*/
		function allCorrect(answer , list){
			let correctFlg = true;
			for (let i = 0 ; i < answer.length ; i++){
				if (answer[i] !== list[i]){
					correctFlg = false;
					return correctFlg;
				}
			}
			return correctFlg;
		}
		
		/** ãƒã‚¹ç›®ã«æ–‡å­—ã‚’æ›¸ãé–¢æ•°
			* gpt
			*/
			function drawBoardLetters(letters) {
				if (letters){
				    const ctx = board.getContext("2d");
					resetSqareColor(false); // æ­£æ–¹å½¢ã®è‰²ã‚’ãƒªã‚»ãƒƒãƒˆ
					boardFlg = true;

				    ctx.font = "30px sans-serif";
				    ctx.textAlign = "center";
				    ctx.textBaseline = "middle";
				    ctx.fillStyle = "white";

				    for (let i = 0; i < n * n; i++) {
				        if (i < letters.length) {
				            const row = Math.floor(i / n);
				            const col = i % n;

				            // å„ãƒã‚¹ã®ä¸­å¿ƒåº§æ¨™
				            const x = offsetX + col * size + size / 2;
				            const y = offsetY + row * size + size / 2;

				            ctx.fillText(letters[i], x, y);
				        }
				    }
				}
			}

			// ãƒã‚¹ç›®ã®æ–‡å­—ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹é–¢æ•°
			function resetBoardLetters() {
			    drawGrid(); // ãƒã‚¹ã‚’å†æç”»
			}

		
		
		/** Sequenceå•é¡Œã®ãƒªã‚»ãƒƒãƒˆå‡¦ç†
		* è§£ç­”ãƒœã‚¿ãƒ³ã®è‰²ã‚’ãƒªã‚»ãƒƒãƒˆ
		* è§£ç­”ãƒªã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
		* è§£ç­”ã‚»ãƒƒãƒˆã‚‚ãƒªã‚»ãƒƒãƒˆ
		*
		*/
		function resetSequence(){
			resetSqareColor(); // æ­£æ–¹å½¢ã®è‰²ã‚’ãƒªã‚»ãƒƒãƒˆ
			answerListSequence.length = 0; // è§£ç­”ã®ãƒªã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
			answerSet.clear(); // ã‚»ãƒƒãƒˆã‚‚ãƒªã‚»ãƒƒãƒˆ
			// è§£ç­”ãƒœã‚¿ãƒ³ã«æ–‡å­—ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’å†æç”»
			if (boardFlg){
				drawBoardLetters(problems[player.floor].squareList);
			}
		}
		
		/** mainã®imgã‚’è¡¨ç¤ºã—ã¦å¼•æ•°ã®ã‚½ãƒ¼ã‚¹ã‚’ã‚»ãƒƒãƒˆ
		*
		*
		*/
		function setMainImage(src){
			main.style.display = "block";
			main.src = src;
		}
		
		/** é›£æ˜“åº¦ã‚’ä¸‹ã’ãªãŒã‚‰ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æš—ç®—å•é¡Œã‚’å†ç”Ÿã™ã‚‹
		*
		*/
		function flashProb(problem){
			problem.answer = problem.yobiAnswer[flashIndex];
			problem.yobi1 = problem.answer.length;
			flashList(problem.yobi2[flashIndex],500);
			if (flashIndex < 4){
				flashIndex++;
			}
			
		}
		
		/** ãƒªã‚¹ãƒˆã®å†…å®¹ã‚’é€£ç¶šã§è¡¨ç¤ºã™ã‚‹é–¢æ•°
		* @param ms ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«
		*
		*/
		function flashList(list , ms) {
		  const center = document.getElementById("center"); // æ—¢å­˜ã®è¦ç´ ã«åˆã‚ã›ã¦å¤‰æ›´
		  let index = 0;

		  flashTimerId = setInterval(() => {
		    if (index >= list.length) {
		      clearInterval(flashTimerId); // æœ€å¾Œã¾ã§è¡¨ç¤ºã—ãŸã‚‰åœæ­¢
		      return;
		    }
		    center.textContent = list[index];
		    index++;
		  }, ms); // 500ms = 0.5ç§’
		}
		
		/** ä¸€ç­†æ›¸ãã§ç”»é¢è¡¨ç¤ºã¨ãƒãƒƒãƒ—ã‚’å¤‰æ›´ã™ã‚‹
		*
		*/
		function oneStrokeMoving(){
			oneStrokeMap[x][y] = 1;
			fillSquare(y,x,"blue");
			if (endMove()){
				if(checkStorokeAnswer()){
					correct();
				}else{
					incorrect();
					if (specStrokeFlg){
						oneStrokeReset(5,7,problems[player.floor].map)
					}else{
						oneStrokeReset(4,3,problems[player.floor].map);
					}
					return true;
				}
			}
			return false;
		}
		/** ä¸€ç­†æ›¸ãã®æ­£èª¤åˆ¤å®š
		*
		*/
		function checkStorokeAnswer() {
		    for (let row = 0; row < oneStrokeMap.length; row++) {
		        for (let col = 0; col < oneStrokeMap[row].length; col++) {
		            if (oneStrokeMap[row][col] !== 1) {
		                return false; // 1ã§ãªã„ãƒã‚¹ãŒã‚ã£ãŸã‚‰ false
		            }
		        }
		    }
		    return true; // å…¨éƒ¨1ãªã‚‰ true
		}
		
		/** ä¸€ç­†æ›¸ãã§ã¾ã é€²ã‚ã‚‹ãƒã‚¹ãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹
		*
		*/
		function endMove(){
			if ((x <= 0 || oneStrokeMap[x-1][y] == 1) &&  (x >= oneStrokeMap.length-1 || oneStrokeMap[x+1][y] == 1) && (y <= 0 || oneStrokeMap[x][y-1] == 1) && (y >= oneStrokeMap[x].length-1 || oneStrokeMap[x][y+1] == 1) ){
				return true;
			}else{
				return false;
			}
		}

		/** ä¸€ç­†æ›¸ãã§ç§»å‹•ã§ãã‚‹å ´åˆã«åº§æ¨™ã‚’ç§»å‹•å¾Œã«ã™ã‚‹
		* @param move ç§»å‹•é‡
		* @param flg  xã‚’ç§»å‹•ã•ã›ã‚‹ãªã‚‰true
		*/
		function checkMove (move,flg){
			let afterX = x;
			let afterY = y;
			if (flg){
				afterX += move;
			}else{
				afterY += move;
			}
			if (afterX < 0 || afterX >= oneStrokeMap.length || afterY < 0 || afterY >= oneStrokeMap[0].length || oneStrokeMap[afterX][afterY] == 1){
				return false;
			}else{
				x = afterX;
				y = afterY;
				let endStrokeFlg = oneStrokeMoving();
				if (endStrokeFlg){
					return false;
				}else {
					return true;
				}
			}
		}
		
		/** 25å•ç›®ã§ãƒ©ã‚¤ãƒˆã‚’å›è»¢ã•ã›ã‚‹
		*
		*/ 
		function rotateCircle(){
			for (let i = 0; i <4 ; i++){
				// å††ã‚’é€æ˜ã«ãƒªã‚»ãƒƒãƒˆ
				clearCircle(i);
			}
			// é…åˆ—ã‚’å›è»¢
			rotateArray();
			for (let i = 0; i <4 ; i++){
				// å††
				if (circleStates[i]){
					fillCircleByIndex(i,problems[player.floor].colors[circleStates[i]]);
				}
				
			}
		}
		
		
		
		/** ç‚¹æ»…æš—è¨˜å•é¡Œã®å†ç”Ÿé–¢æ•°
		* @param {*} list ç‚¹æ»…ã™ã‚‹é †ç•ªã®ãƒªã‚¹ãƒˆ
		* @param {*} time ç‚¹æ»…ã—ã¦ã„ã‚‹æ™‚é–“ã®ãƒªã‚¹ãƒˆ
		*/
		function flash(list,time){
			canOperate = false;
			setTimeout(()=>{
				blinkSequence(list);
			},1000);
			setTimeout(()=>{
				document.getElementById("message").textContent = "é †ã«æŠ¼ã›";
				canOperate = true;
			},time); 
		}
		
		/** å††ã‚’é€æ˜ã«ã™ã‚‹ (circleStatesã®ãƒªã‚»ãƒƒãƒˆã¯åˆ¥ã§ã‚„ã‚‹)
		*
		*/

		function clearCircle(index) {
		    const [x, y] = positions[index];
		    const r = 40;

		    ctx.save(); // çŠ¶æ…‹ä¿å­˜
		    ctx.globalCompositeOperation = "destination-out"; // ä¸Šæ›¸ãã§é€æ˜ã«ã™ã‚‹
		    ctx.beginPath();
		    ctx.arc(x, y, r, 0, Math.PI * 2);
		    ctx.fill();
		    ctx.restore(); // çŠ¶æ…‹å¾©å…ƒ

		}
		
		/**
		* ç”»é¢ã®ä¸­å¿ƒã«4ã¤ã®å††ã‚’æç”»ã™ã‚‹é–¢æ•°
		*/
		function drawFourCircles() {
		    const centerX = canvas.width / 2 ;
		    const centerY = canvas.height / 2 + 150 ;
		    const radius = 40;      // å††ã®åŠå¾„
		    const gap = 250;        // ä¸­å¿ƒã‹ã‚‰ã®è·é›¢ï¼ˆååˆ†ãªè·é›¢ã‚’ã¨ã‚‹ï¼‰

		    positions.push([centerX - gap, centerY]);
			positions.push([centerX + gap, centerY]);
			positions.push([centerX, centerY - gap]);
			positions.push([centerX, centerY + gap]);


		    ctx.lineWidth = 3;

		    positions.forEach(([x, y]) => {
		        ctx.beginPath();
		        ctx.arc(x, y, radius, 0, Math.PI * 2);
				ctx.strokeStyle = "white";
		        ctx.stroke();
				circlePositions.push({x,y,r:radius}); // åº§æ¨™ã¨åŠå¾„ã‚’å¡—ã‚Šã¤ã¶ã—ã®ãŸã‚ã«ä¿å­˜
		    });
		}

		/** ãƒ©ã‚¤ãƒˆ(ä¸­å¿ƒã®ä¸¸)ã‚’å¡—ã‚Šã¤ã¶ã™
		* @param {number} index 0 ~ 3
		* 
		*/

		function fillCircleByIndex(index, color) {
		    const c = circlePositions[index];
		    if (!c) return;

		    ctx.beginPath();
		    ctx.arc(c.x, c.y, c.r, 0, Math.PI * 2);
		    ctx.fillStyle = color;
		    ctx.fill();
		    ctx.strokeStyle = "white"; // æ ã‚‚ç¶­æŒ
		    ctx.stroke();
		}
		

		/** ã‚­ãƒ¼ã«å¯¾å¿œã—ãŸãƒ”ã‚¢ãƒéŸ³ã‚’å†ç”Ÿ
		*
		*/
		function piano(key){
			switch (key){
				case "4": {
					new Audio("/piano/la.mp3").play();
					break;
				}
				case "8": {
					new Audio("/piano/so.mp3").play();
					break;
				}
				case "1": {
					new Audio("/piano/do.mp3").play();
					break;
				}
				case "7": {
					new Audio("/piano/mi.mp3").play();
					break;
				}
				case "3": {
					new Audio("/piano/re.mp3").play();
					break;
				}
				case "2": {
					new Audio("/piano/do2.mp3").play();
					break;
				}
				case "6": {
					new Audio("/piano/fa.mp3").play();
					break;
				}
				case "5": {
					new Audio("/piano/si.mp3").play();
					break;
				}
			}

		}
		
		/** ä¸€ç­†æ›¸ãã®åˆæœŸåŒ–å‡¦ç†
		 * @param {number} syokiX - ã‚¹ã‚¿ãƒ¼ãƒˆä½ç½®ã®xåº§æ¨™
		 * @param {number} syokiY - ã‚¹ã‚¿ãƒ¼ãƒˆä½ç½®ã®yåº§æ¨™
		 * @param {Array<Array<number>>} syokiMap - åˆæœŸãƒãƒƒãƒ—ï¼ˆ0:é€šè·¯, 1:å£ï¼‰
		 */
		function oneStrokeReset(syokiX, syokiY, syokiMap) {
		    // ã¾ãšãƒãƒƒãƒ—ã‚’ã‚³ãƒ”ãƒ¼
		    for (let row = 0; row < syokiMap.length; row++) {
		        for (let col = 0; col < syokiMap[row].length; col++) {
		            oneStrokeMap[row][col] = syokiMap[row][col];
		        }
		    }

		    // ã‚­ãƒ£ãƒ³ãƒã‚¹å…¨ä½“ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‚°ãƒªãƒƒãƒ‰å†æç”»
		    ctx.clearRect(0, 0, canvas.width, canvas.height);
			if (specStrokeFlg){
				makeSquaresGrid(9);
			}else {
				makeSquaresGrid(8);
			}

			// ãƒãƒƒãƒ—ã®1ã‚’ç™½ã§å¡—ã‚‹
			for (let row = 0; row < oneStrokeMap.length; row++) {
			    for (let col = 0; col < oneStrokeMap[row].length; col++) {
			        if (oneStrokeMap[row][col] === 1) {
			            fillSquare(col, row,"white"); // fillSquare ã¯ (x, y) ã§å¡—ã‚‹
			        }
			    }
			}


		    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½ç½®ã‚’åˆæœŸä½ç½®ã«ã‚»ãƒƒãƒˆ
		    x = syokiX;
		    y = syokiY;

		    // ã‚¹ã‚¿ãƒ¼ãƒˆä½ç½®ã‚‚å¡—ã‚‹
		    fillSquare(y, x,"blue");
			oneStrokeMap[x][y] = 1;
		}


		/** ã‚­ãƒ¼ã‚’å—ã‘å–ã£ã¦checkMoveã‚’å‘¼ã³å‡ºã™
		*
		*/
		function moving(key){
			switch(key){
				case "2": {
					return checkMove(-1,true);
				}
				case "4": {
					return checkMove(-1,false);
				}
				case "6": {
					return checkMove(1,false);
				}
				case "8": {
					return checkMove(1,true);
				}
			}
		}
		
		/** æ™‚é–“ã®ä¸‹ä¸€æ¡ã«å¿œã˜ã¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿”ã™
		*
		*/
		function timeProb(){
			if (totalSeconds%10 == 1){
				return 1;
			}else if (totalSeconds%10 == 3){
				return 2;
			}else if (totalSeconds%10 == 5){
				return 3;
			}else if (totalSeconds%10 == 7){
				return 4;
			}else{
				return 5;
			}
		}
		
		/** ç”»åƒã‚’ãƒªã‚¹ãƒˆã§æç”»ã™ã‚‹é–¢æ•°
		*
		*
		*/
		function useMainImageList(imageList , key){
			setMainImage(imageList[key]);
		}
		
		/**
		*
		*/
		function flgReset(){
			boardFlg = false; // è§£ç­”ãƒœã‚¿ãƒ³ã«æ–‡å­—ã‚’ç½®ãã‹ã©ã†ã‹
			flash1Flg = false; // ç‚¹æ»…å•é¡Œ1ã®å°‚ç”¨ãƒ•ãƒ©ã‚°
			flash2Flg = false; // ç‚¹æ»…å•é¡Œ1ã®å°‚ç”¨ãƒ•ãƒ©ã‚°
			simulSequenceFlg = false // ç‚¹æ»…æš—è¨˜ãƒ¬ãƒ™ãƒ«2ã®ãƒ•ãƒ©ã‚°(é€£ç¶šåŒæ™‚æŠ¼ã—ãƒ•ãƒ©ã‚°)
			fruitFlg = false // ãƒ•ãƒ«ãƒ¼ãƒ„å•é¡Œã®ãƒ•ãƒ©ã‚°
			chakaFlg = false;
			chakaFlg2 = false;
			doubleFlg = false; // é€£ç¶šæŠ¼ã—å•é¡Œã®2å›æŠ¼ã—å•é¡Œ
			pianoFlg = false; // éŸ³éšå•é¡Œã®ãƒ•ãƒ©ã‚°
			flashMemoFlg = false; // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æš—è¨˜å•é¡Œã®ãƒ•ãƒ©ã‚°
			flashCulcFlg = false; // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æš—ç®—å•é¡Œã®ãƒ•ãƒ©ã‚°
			crossFlg = false; // xã‚’æ•°ãˆã‚‹å•é¡Œã®ãƒ•ãƒ©ã‚°
			specStrokeFlg = false; // ä¸€ç­†æ›¸ãå•é¡Œã®ç‰¹æ®Šãƒ•ãƒ©ã‚°
			trainFlg = false; // ä¹—å®¢ã‚«ã‚¦ãƒ³ãƒˆå•é¡Œã®ãƒ•ãƒ©ã‚°
			primeFlg = false; // ç´ æ•°å•é¡Œã®ãƒ•ãƒ©ã‚°
			spotDiffFlg = false; // é–“é•ã„æ¢ã—å•é¡Œã®ãƒ•ãƒ©ã‚°
			trainCount.style.display = "none";
		}
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
			
		/*
		* ãƒã‚¹ã®æº–å‚™
		*/
		const size = 90;   // ãƒã‚¹ã®ã‚µã‚¤ã‚º
		const n = 3;       // ãƒã‚¹ã®æ•°
		let offsetX = 1580; // Xæ–¹å‘ã®ç§»å‹•é‡
		let offsetY = 725; // Yæ–¹å‘ã®ç§»å‹•é‡
			
		/*
		* canvasã®æº–å‚™
		*/
		const canvas = document.getElementById("board");
		canvas.width = 1900;
		canvas.height = 1000;
		const ctx = canvas.getContext("2d");
		

		/** éšå±¤ç§»å‹•å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹
		*
		* 
		*/
		function changeFloor() {
		
		    changeFloorUtil(); // å…±é€šå‡¦ç†ã‚’ã¾ãšå®Ÿè¡Œ
			const problem = problems[player.floor];
			if (lastFlg){
				flgReset();
			}
			switch(player.floor) {
		        case 1: {
		            // 1å•ç›®ã®å‡¦ç†
		            blinkInterval = setInterval(() => {
		                blink(0, 0, "white");
		            }, 800);
		            break;
		        }
				case 2: {
					makeSquare();
					break;
				}
				case 3: {
				    // player.floor ãŒ 2 ã®ã¨ãã®å‡¦ç†
				    setMainImage("tower_4th_kanji.png");
				    break;
				}	
				case 4: {
					setMainImage("tower_5th_kanji.png");
					break;
				}	
				case 5: {
					blinkInterval = setInterval(() => {
						blink(0,1,"white");
						blink(1,1,"white");
						blink(2,1,"white");
					}, 800);
					break;
				}
				case 6: {
					oneStrokeReset(4,3,problems[player.floor].map);
					break;
				}case 7: {
					drawBoardLetters(problems[player.floor].squareList); // ã“ã‚Œæ›œæ—¥
					setMainImage("month.png");
					boardFlg = true;
					break;
				}
				case 8: {
					flash1Flg = true;
					boardFlg = false;
					message.textContent = "è¦šãˆã‚‹";
					flash( [2,7,6,9,1,3,8,5,4],5500);
					break;
				}
				case 9: {
					drawBoardLetters(["1","2","3","4","5","6","7","8","9"]);
					flash1Flg = false;
					spotDiffFlg = true;
					setMainImage("é–“é•ã„æ¢ã—ç”»åƒ.png");
					break;
				}
				case 10: {
					boardFlg = false;
					spotDiffFlg = false;
					oneStrokeReset(4,3,problems[player.floor].map);
					drawGrid();
					break;
				}
				case 11: {
					simulSequenceFlg = true;
					flash2Flg = true;
					canOperate = false;
					setTimeout(()=>{
						blinkSequence(["1","5","1","1"]);
						blinkSequence(["2","6","4","2"]);
						blinkSequence(["5","7","6","3"]);
						blinkSequence(["9","8","9","5"]);
					},1000);
					setTimeout(()=>{
						document.getElementById("message").textContent = "é †ã«æŠ¼ã›";
						canOperate = true;
					},3300);
					break;
				}
				case 12: {
					setMainImage("ä¹ä¹.png");
					simulSequenceFlg = false;
					flash2Flg = false;
					break;
				}
				case 13: {
					setMainImage("tower_7th_month.png");
					drawBoardLetters(problem.squareList);
					break;
				}
				case 14: {
					boardFlg = false;
					setMainImage("corner.png");
					break;
				}
				case 15: {
					drawBoardLetters(["1","2","3","4","æ±º","6","7","8","9"]);
					boardFlg = true;
					break;
				}case 16: {
					drawBoardLetters(["11","13","8","18","10","24","14","7","16"]);
					boardFlg = false;
					chakaFlg = true;
					break;
				}case 17: {
					drawBoardLetters(["19","21","13","17","15","24","20","13","18"]);
					chakaFlg = false;
					chakaFlg2 = true;
					break;
				}
				case 18: {
					boardFlg = false;
					chakaFlg = false;
					setMainImage("æ•°å­—.png");
					break;
					
				}
				case 19: {
					drawFourCircles();
					break;
				}
				case 20: {
					center.textContent = sumCount;
					break;
				}
				case 21: {
					doubleFlg = true;
					setMainImage("ã‚·ãƒ§ãƒ¼ãƒˆã‚±ãƒ¼ã‚­(ç™½ãªã—).png");
					break;
				}
				case 22: {
					doubleFlg = false;
					setMainImage("pianoImage.png");
					pianoFlg = true;
					break;
				}
				case 23: {
					pianoFlg = false;
					flashCulcFlg = true;
					drawBoardLetters(["1","2","3","4","5","6","7","8","9"]);
					flashProb(problem);
					break;
					break;
				}
				case 24: {
					boardFlg = false;
					flashCulcFlg = false;
					changeSquareColor(changeNum(1)[0],changeNum(1)[1],"red");
					changeSquareColor(changeNum(3)[0],changeNum(3)[1],"blue");
					changeSquareColor(changeNum(7)[0],changeNum(7)[1],"green");
					changeSquareColor(changeNum(9)[0],changeNum(9)[1],"yellow");
					fruitFlg = true;
					break;
				}
				case 25: {
					setMainImage("æ™‚è¨ˆ.png");
					fruitFlg = false;
					drawFourCircles();
					break;
				}
				case 26: {
					flashMemoFlg = true;
					canOperate = false;
					drawBoardLetters(["1","2","3","4","5","6","7","8","9"]);
					setTimeout(() => {
						flashList(problem.flashList,500);
					},500);
					setTimeout(() => {
						message.textContent = "ç­”ãˆã‚";
						canOperate = true;
					},5000)
					break;
				}
				case 27: {
					boardFlg = false;
					flashMemoFlg = false;
					setMainImage("tower_6th_rainbow/1color.png");
					changeSquareColor(0,1,"blue");
					changeSquareColor(2,1,"skyblue");
					changeSquareColor(1,0,"green");
					changeSquareColor(1,1,"yellow");
					changeSquareColor(0,0,"orange");
					changeSquareColor(2,0,"red");
					break;
				}
				case 28 : {
					drawBoardLetters(["10","11","12","13","14","15","16","17","18"]);
					crossFlg = true;
					canOperate = false;
					setTimeout(() => {
						flashList(cross,300);
					},500)
					setTimeout(() => {
						canOperate = true;
						message.textContent = "ç­”ãˆã‚";
					},7500);
					break;
				}
				case 29 : {
					boardFlg = false;
					crossFlg = false;
					oneStrokeMap = Array.from({ length: 9 }, () => Array(10).fill(0)); // ä¸€ç­†æ›¸ãã®çŠ¶æ³ã‚’ä¿å­˜ã™ã‚‹ãƒãƒƒãƒ—ã‚’29å•ç›®ç”¨ã«æ›´æ–°(æ”¹å–„ã®ä½™åœ°ã‚ã‚Š)
					specStrokeFlg = true;
					oneStrokeReset(5,7,problems[player.floor].map);
					break;
				}
				case 30 : {
					drawBoardLetters(["1","2","3","4","5","6","7","8","9"]);
					canOperate = false;
					flashList(problem.yobi2,500);
					setTimeout(() => {
						canOperate = true;
					},3000); // ã“ã“ã‚‚ã¡ã‚ƒã‚“ã¨ç¢ºã‹ã‚ãŸ
					problem.yobi1 = player.qrid.length ;
					break;
				}
				case 31 : {
					setMainImage("å­¤ç«‹æ¢ã—.png");
					drawBoardLetters(["1","2","3","4","5","6","7","8","9"]);
					break;
				}
				case 32 : {
					trainFlg = true;
					drawBoardLetters(["1","2","3","4","5","6","7","8","9"]);
					trainCount.style.display = "block";
					break;
				}
				case 33 : {
					boardFlg = false;
					darumaFlg = true;
					sub.textContent = darumaCount;
					trainCount.style.display = "none";
					break;
				}
				case 34 : {
					darumaFlg = false;
					daruma.pause();
					
					primeFlg = true;
					daruma.style.display = "none";
					drawBoardLetters(["1","2","3","4","5","6","7","8","9"]);
					canOperate = false;
					setTimeout(() => {
						flashList(prime,400);
					},500)
					setTimeout(() => {
						canOperate = true;
						message.textContent = "ç­”ãˆã‚";
					},9000);
					break;
				}
				case 35 : {
					primeFlg = false;
					lastFlg = true;
					break;
					
				}
			}
			if (lastFlg){
				resetBoardLetters();
				drawBoardLetters(lastList[lastIndex%6]);
				
			}
		}

			

	
		
		
		startPolling(pcNum); //ãƒãƒ¼ãƒªãƒ³ã‚°ã®èµ·å‹•
		
		
	</script>
</body>
</html>